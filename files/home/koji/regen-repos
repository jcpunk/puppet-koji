#!/bin/bash
####################################################
# HEADER: This file was autogenerated by puppet.
#
# FILE: modules/koji/files/home/koji/regen-repos
#
# /home/koji/regen-repos file for machine [<%= fqdn %>]
#
#####################################################

# setup args in the right order for making getopt evaluation
# nice and easy.  You'll need to read the manpages for more info
args=$(getopt -o h -- "$@")
eval set -- "$args"

usage() {
    echo "$0:" >&2
    echo '' >&2
    echo ' This will have koji re-cache repodata for all relevant tags' >&2
    echo '' >&2

    exit 1
}

CPUS=''
for arg in $@; do
    case $1 in
        -- )
            # end of getopt args, shift off the -- and get out of the loop
            shift
            break 2
           ;;
         -h )
            # get help
            usage
           ;;
    esac
done

for tag in $(koji list-tags); do
    INFO=$(koji taginfo ${tag})
    echo ${INFO} | grep LOCKED >/dev/null
    if [[ $? -eq 0 ]]; then
        # Don't regen locked tags, its pointless
        continue
    fi

    echo ${INFO} |grep 'Current repo:' >/dev/null
    if [[ $? -eq 0 ]]; then
        koji regen-repo --nowait ${tag} >/dev/null 2>&1
    fi
done
