#!/bin/bash
####################################################
# HEADER: This file was autogenerated by puppet.
#
# FILE: modules/koji/files/home/koji/cleanup-koji-host
#
# /home/koji/cleanup-koji-host file for machine [<%= fqdn %>]
#
#####################################################

# setup args in the right order for making getopt evaluation
# nice and easy.  You'll need to read the manpages for more info
args=$(getopt -o h -- "$@")
eval set -- "$args"

usage() {
    echo "$0: hostname" >&2
    echo '' >&2
    echo ' If you start kojid before you run "koji add-host"' >&2
    echo ' koji will make an incorrect account type for your' >&2
    echo ' system.' >&2
    echo ' This script removes the bogus account type' >&2
    echo '' >&2

    exit 1
}

CPUS=''
for arg in $@; do
    case $1 in
        -- )
            # end of getopt args, shift off the -- and get out of the loop
            shift
            break 2
           ;;
         -h )
            # get help
            usage
           ;;
    esac
done

HOSTNAME=$1

if [[ "x$HOSTNAME" == 'x' ]]; then
    usage
fi

HOSTID=$(psql -qt koji koji --command "select id from users where name='$HOSTNAME';"|awk '{print $1}'|grep \.)
if [[ "x$HOSTID" == 'x' ]]; then
    exit 0
fi

psql -qt koji koji --command "delete from sessions where user_id='$HOSTID';"
if [[ $? -ne 0 ]]; then
    exit 1
fi

psql -qt koji koji --command "delete from users where id='$HOSTID';"
if [[ $? -ne 0 ]]; then
    exit 1
fi

