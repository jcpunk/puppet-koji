#!/bin/bash
####################################################
# HEADER: This file was autogenerated by puppet.
#
# FILE: modules/koji/files/root/bin/add_koji_user
#
# /home/koji/bin/add_koji_user file for machine [<%= fqdn %>]
#
#####################################################

# setup args in the right order for making getopt evaluation
# nice and easy.  You'll need to read the manpages for more info
args=$(getopt -o ha -- "$@")
eval set -- "$args"

usage() {
    echo "$0: [-a] username" >&2
    echo '' >&2
    echo "  -a : make this user a koji admin" >&2
    echo '' >&2
    echo '  An SSL cert will also be attempted' >&2
    echo '  check in /etc/pki/koji/pems/ for the results' >&2
    echo '' >&2
    echo ' Examples:' >&2
    echo "  $0 -a my_admin" >&2
    echo "  $0 just_someone">&2
    
    exit 1
}

ADMIN='n'
for arg in $@; do
    case $1 in
        -- )
            # end of getopt args, shift off the -- and get out of the loop
            shift
            break 2
           ;;
         -a )
            ADMIN='y'
            shift
           ;;
         -h )
            # get help
            usage
           ;;
    esac
done

if [[ "x$1" == 'x' ]]; then
    usage
fi

if [[ ! -f /etc/pki/koji/pems/${1}.pem ]]; then
    /etc/pki/koji/make_koji_service_cert.sh -c $1
fi

koji add-user $1

if [[ "$ADMIN" == 'y' ]]; then
    koji grant-permission admin $1
fi
